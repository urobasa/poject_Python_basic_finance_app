{% extends 'base.html' %}
{% block title %}–ö–∞—Ç–µ–≥–æ—Ä–∏–∏{% endblock %}

{% block content %}
<h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>

<a href="{{ url_for('categories.create_category_view') }}" class="btn btn-success mb-3">
  ‚ûï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
</a>

<table class="table table-bordered table-sm" id="category-table">
  <thead>
    <tr>
      <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
      <th style="width:1%; white-space: nowrap;">–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody>
    <tr class="table-secondary">
      <td colspan="2"><strong>–†–∞—Å—Ö–æ–¥</strong></td>
    </tr>
    {% for cat in categories if cat.type == 'expense' %}
      <tr data-id="{{ cat.id }}" data-parent-id="{{ cat.parent_id }}"
          class="{% if cat.parent_id %}d-none child-of-{{ cat.parent_id }}{% endif %}">
        <td style="padding-left: {{ cat.level * 20 }}px;">
          {% if cat.has_children %}
            <span class="toggle-arrow" style="cursor: pointer;">‚ñ∂</span>
          {% endif %}
          {{ cat.name }}
        </td>
        <td style="white-space: nowrap;">
          <a href="{{ url_for('categories.edit_category_view', category_id=cat.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
          <a href="{{ url_for('categories.confirm_delete_category', category_id=cat.id) }}" class="btn btn-sm btn-danger">üóë</a>
        </td>
      </tr>
    {% endfor %}

    <tr class="table-secondary">
      <td colspan="2"><strong>–î–æ—Ö–æ–¥</strong></td>
    </tr>
    {% for cat in categories if cat.type == 'income' %}
      <tr data-id="{{ cat.id }}" data-parent-id="{{ cat.parent_id }}"
          class="{% if cat.parent_id %}d-none child-of-{{ cat.parent_id }}{% endif %}">
        <td style="padding-left: {{ cat.level * 20 }}px;">
          {% if cat.has_children %}
            <span class="toggle-arrow" style="cursor: pointer;">‚ñ∂</span>
          {% endif %}
          {{ cat.name }}
        </td>
        <td style="white-space: nowrap;">
          <a href="{{ url_for('categories.edit_category_view', category_id=cat.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
          <a href="{{ url_for('categories.confirm_delete_category', category_id=cat.id) }}" class="btn btn-sm btn-danger">üóë</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.querySelectorAll("#category-table .toggle-arrow").forEach(arrow => {
  arrow.addEventListener("click", (e) => {
    e.stopPropagation();
    const row = arrow.closest("tr");
    const id = row.dataset.id;
    const children = document.querySelectorAll(`#category-table tr[data-parent-id='${id}']`);
    const show = Array.from(children).some(child => child.classList.contains("d-none"));
    children.forEach(child => {
      child.classList.toggle("d-none", !show);
      if (!show) {
        const descendants = document.querySelectorAll(`#category-table tr[data-parent-id='${child.dataset.id}']`);
        descendants.forEach(d => d.classList.add("d-none"));
      }
    });
  });
});
</script>
{% endblock %}