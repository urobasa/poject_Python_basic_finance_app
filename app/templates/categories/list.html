{% extends 'base.html' %}
{% block title %}–ö–∞—Ç–µ–≥–æ—Ä–∏–∏{% endblock %}

{% block content %}
<h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
<table class="table table-bordered table-sm" id="category-table">
  <thead>
    <tr>
      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
      <th>–¢–∏–ø</th>
      <th>–†–æ–¥–∏—Ç–µ–ª—å</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody>
    {% for cat in categories %}
    <tr data-id="{{ cat.id }}" data-parent-id="{{ cat.parent_id }}" data-has-children="{{ cat.has_children|lower }}"
        class="{% if cat.parent_id %}d-none child-of-{{ cat.parent_id }}{% endif %}">
      <td style="padding-left: {{ cat.level * 20 }}px; cursor: pointer;">
        {% if cat.has_children %}
          ‚ñ∂ 
        {% endif %}
        {{ cat.name }}
      </td>
      <td>{% if cat.type == 'income' %}–î–æ—Ö–æ–¥{% else %}–†–∞—Å—Ö–æ–¥{% endif %}</td>
      <td>{% if cat.parent_id %}{{ cat.parent_id }}{% else %}‚Äî{% endif %}</td>
      <td>
        <a href="{{ url_for('categories.edit_category_view', category_id=cat.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
        <a href="{{ url_for('categories.confirm_delete_category', category_id=cat.id) }}" class="btn btn-sm btn-danger">üóë</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<a href="{{ url_for('categories.create_category_view') }}" class="btn btn-success">
  ‚ûï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
</a>

<script>
document.querySelectorAll("#category-table tr[data-has-children='true']").forEach(row => {
  row.addEventListener("click", (e) => {
    if (!e.target.closest("a")) {  // ignore clicks on buttons
      const id = row.dataset.id;
      const children = document.querySelectorAll(`#category-table tr[data-parent-id='${id}']`);
      const show = Array.from(children).some(child => child.classList.contains("d-none"));
      children.forEach(child => {
        child.classList.toggle("d-none", !show);

        // –µ—Å–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
        if (!show) {
          const descendants = document.querySelectorAll(`#category-table tr[data-parent-id='${child.dataset.id}']`);
          descendants.forEach(d => d.classList.add("d-none"));
        }
      });
    }
  });
});
</script>
{% endblock %}
